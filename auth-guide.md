## Ключевые концепции авторизации

### Токены: Цифровые ключи доступа

В большинстве современных веб-приложений для управления доступом используются токены. Вместо того чтобы хранить пароль на клиенте, система после успешного входа выдает временный ключ – токен.

Существует два основных типа токенов:

| Тип токена | Назначение | Время жизни | Безопасность |
| :--- | :--- | :--- | :--- |
| **Access Token** | Предоставляет доступ к ресурсам (API, данные профиля). | Короткое (~15 минут) | Передается в заголовке `Authorization: Bearer <token>`. Его кража дает недолгий доступ. |
| **Refresh Token** | Используется для получения нового access token, когда старый истек. | Длинное (7-30 дней) | Хранится в безопасном месте (например, HttpOnly cookie) и используется только для обращения к специальному эндпоинту. |

Эта двухтокенная система значительно повышает безопасность: даже если access token будет перехвачен, злоумышленник получит доступ лишь на очень короткое время.

### Хэширование паролей

⚠️ **Никогда не храните пароли в открытом виде!**

Пароли должны проходить через процесс хэширования – одностороннего криптографического преобразования. Популярные и надежные алгоритмы – **bcrypt** и **Argon2**.

### Двухфакторная аутентификация (2FA) и OTP

Для повышения безопасности используется двухфакторная аутентификация. Это метод, требующий подтверждения личности двумя разными способами:
1. **Фактор знания:** то, что вы знаете (пароль).
2. **Фактор владения:** то, чем вы владеете (телефон для получения SMS).

**OTP (One-Time Password)** – это одноразовый пароль, который генерируется на короткое время (обычно 1-5 минут).

## Как отображать HTTP и SQL в sequence-диаграммах

Sequence-диаграмма идеально подходит для визуализации взаимодействия между компонентами системы.

### Участники (Participants)
* `actor User`: Конечный пользователь.
* `boundary App`: Клиентское приложение.
* `participant Auth Service`: Бэкенд-сервис.
* `database Database`: База данных.

### Сообщения (Messages)
* **HTTP-запросы:** Стрелка от клиента к серверу. Пример: `POST /api/v1/auth/login {email, password}``
* **HTTP-ответы:** Пунктирная стрелка от сервера к клиенту. Пример: `200 OK {access_token}``
* **SQL-запросы:** Стрелка от сервиса к базе данных. Пример: `SELECT * FROM users WHERE email = ?``

### Фреймы (Frames)
* `alt`: Для условных потоков (успех vs ошибка).
* `opt`: Для опциональных действий.
* `loop`: Для циклов.

## Таблица HTTP-статусов для авторизации

| Код | Название | Когда использовать |
| :--- | :--- | :--- |
| **200 OK** | Успех | Успешный вход, обновление токена. |
| **201 Created** | Создано | Успешная регистрация. |
| **401 Unauthorized** | Не авторизован | Неверный пароль, истекший токен. |
| **403 Forbidden** | Запрещено | Доступ запрещен (нет прав). |
| **429 Too Many Requests** | Слишком много запросов | Защита от brute force. |

## 4. Основные SQL-операции в авторизации

| Операция | SQL-запрос | Назначение |
| :--- | :--- | :--- |
| | **Создание пользователя** | `INSERT INTO users ...` | Регистрация. |
| **Поиск пользователя** | `SELECT * FROM users WHERE email = ?` | Вход в систему. | |
| | **Сохранение Refresh Token** | `INSERT INTO refresh_tokens ...` | При входе. |
| **Отзыв токенов** | `DELETE FROM refresh_tokens ...` | Выход (Logout). | |

## 5. Правила безопасности

| Угроза | Защита |
| :--- | :--- |
| **Brute Force** | Rate limiting + блокировка после N неудачных попыток. |
| **CSRF** | SameSite cookies + CSRF-токены. |
| **XSS** | HTTP-only cookies для токенов. |
| **SQL Injection** | Использование ORM или параметризованных запросов. |
